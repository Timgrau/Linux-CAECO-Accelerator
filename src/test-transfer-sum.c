#include <stdlib.h>
#include <stdbool.h>
#include "libaxidma.h"          // Interface ot the AXI DMA library
#include <stdio.h>
#include <unistd.h>

void print_buffer(int* buffer, int size);
void fill_tx_buffer(char *tx_buffer, size_t tx_buff_size, char *payload);
void fill_buffers(char *tx_buffer, size_t tx_buff_size, char *rx_buffer,
		  size_t rx_buff_size, char *payload);
//int sum_buffer(int *buffer, int size);
void calc_output(int *buffer, int size);

int main(void)
{
  int rc = 0;
  
  //==== AXI-DMA ====
  axidma_dev_t axidma_dev;
  
  axidma_dev = axidma_init();
  if(axidma_dev == NULL) {
    fprintf(stderr, "Failed to initialize the AXI DMA device!\n");
    
    return -1;
  } else printf("INFO: Initialized AXI DMA device.\n");
  
  
  // test payload
  char *message = "{\"vibration\":[{\"x\":-13375,\"y\":194,\"z\":-220},{\"x\":-13385,\"y\":196,\"z\":-223},{\"x\":-13390,\"y\":194,\"z\":-218},{\"x\":-13385,\"y\":182,\"z\":-227},{\"x\":-13374,\"y\":199,\"z\":-221},{\"x\":-13379,\"y\":193,\"z\":-213},{\"x\":-13372,\"y\":192,\"z\":-205},{\"x\":-13372,\"y\":205,\"z\":-212},{\"x\":-13374,\"y\":190,\"z\":-219},{\"x\":-13364,\"y\":193,\"z\":-223},{\"x\":-13369,\"y\":186,\"z\":-221},{\"x\":-13371,\"y\":182,\"z\":-220},{\"x\":-13394,\"y\":190,\"z\":-224},{\"x\":-13378,\"y\":191,\"z\":-219},{\"x\":-13382,\"y\":196,\"z\":-224},{\"x\":-13392,\"y\":183,\"z\":-217},{\"x\":-13388,\"y\":197,\"z\":-225},{\"x\":-13376,\"y\":189,\"z\":-218},{\"x\":-13391,\"y\":189,\"z\":-234},{\"x\":-13378,\"y\":176,\"z\":-233},{\"x\":-13381,\"y\":189,\"z\":-226},{\"x\":-13378,\"y\":191,\"z\":-225},{\"x\":-13393,\"y\":189,\"z\":-214},{\"x\":-13376,\"y\":196,\"z\":-218},{\"x\":-13384,\"y\":196,\"z\":-206},{\"x\":-13384,\"y\":201,\"z\":-230},{\"x\":-13377,\"y\":184,\"z\":-213},{\"x\":-13383,\"y\":181,\"z\":-224},{\"x\":-13374,\"y\":187,\"z\":-221},{\"x\":-13366,\"y\":188,\"z\":-219},{\"x\":-13363,\"y\":195,\"z\":-207},{\"x\":-13366,\"y\":185,\"z\":-212},{\"x\":-13369,\"y\":185,\"z\":-212},{\"x\":-13376,\"y\":189,\"z\":-231},{\"x\":-13371,\"y\":194,\"z\":-226},{\"x\":-13379,\"y\":192,\"z\":-223},{\"x\":-13362,\"y\":198,\"z\":-221},{\"x\":-13376,\"y\":186,\"z\":-211},{\"x\":-13373,\"y\":190,\"z\":-221},{\"x\":-13375,\"y\":184,\"z\":-233},{\"x\":-13374,\"y\":195,\"z\":-221},{\"x\":-13371,\"y\":188,\"z\":-222},{\"x\":-13386,\"y\":181,\"z\":-214},{\"x\":-13382,\"y\":189,\"z\":-213},{\"x\":-13380,\"y\":187,\"z\":-224},{\"x\":-13387,\"y\":191,\"z\":-213},{\"x\":-13386,\"y\":206,\"z\":-205},{\"x\":-13382,\"y\":202,\"z\":-220},{\"x\":-13372,\"y\":182,\"z\":-220},{\"x\":-13380,\"y\":191,\"z\":-205},{\"x\":-13366,\"y\":187,\"z\":-222},{\"x\":-13373,\"y\":200,\"z\":-208},{\"x\":-13372,\"y\":197,\"z\":-208},{\"x\":-13368,\"y\":202,\"z\":-210},{\"x\":-13369,\"y\":189,\"z\":-230},{\"x\":-13366,\"y\":178,\"z\":-213},{\"x\":-13380,\"y\":179,\"z\":-209},{\"x\":-13375,\"y\":194,\"z\":-227},{\"x\":-13373,\"y\":184,\"z\":-225},{\"x\":-13372,\"y\":189,\"z\":-219},{\"x\":-13376,\"y\":195,\"z\":-228},{\"x\":-13366,\"y\":204,\"z\":-215},{\"x\":-13373,\"y\":193,\"z\":-217},{\"x\":-13374,\"y\":188,\"z\":-238},{\"x\":-13385,\"y\":183,\"z\":-215},{\"x\":-13378,\"y\":189,\"z\":-222},{\"x\":-13375,\"y\":196,\"z\":-218},{\"x\":-13380,\"y\":198,\"z\":-219},{\"x\":-13385,\"y\":195,\"z\":-226},{\"x\":-13379,\"y\":198,\"z\":-221},{\"x\":-13384,\"y\":194,\"z\":-218},{\"x\":-13387,\"y\":195,\"z\":-208},{\"x\":-13382,\"y\":194,\"z\":-213},{\"x\":-13367,\"y\":196,\"z\":-223},{\"x\":-13356,\"y\":203,\"z\":-220},{\"x\":-13373,\"y\":199,\"z\":-225},{\"x\":-13363,\"y\":188,\"z\":-219},{\"x\":-13373,\"y\":194,\"z\":-227},{\"x\":-13376,\"y\":194,\"z\":-229},{\"x\":-13377,\"y\":193,\"z\":-216},{\"x\":-13376,\"y\":199,\"z\":-221},{\"x\":-13373,\"y\":192,\"z\":-224},{\"x\":-13374,\"y\":191,\"z\":-209},{\"x\":-13370,\"y\":192,\"z\":-218},{\"x\":-13377,\"y\":197,\"z\":-224},{\"x\":-13380,\"y\":194,\"z\":-223},{\"x\":-13387,\"y\":194,\"z\":-228},{\"x\":-13384,\"y\":195,\"z\":-224},{\"x\":-13385,\"y\":203,\"z\":-215},{\"x\":-13378,\"y\":198,\"z\":-222},{\"x\":-13380,\"y\":189,\"z\":-224},{\"x\":-13376,\"y\":190,\"z\":-223},{\"x\":-13384,\"y\":190,\"z\":-208},{\"x\":-13377,\"y\":190,\"z\":-213},{\"x\":-13374,\"y\":210,\"z\":-223},{\"x\":-13366,\"y\":181,\"z\":-215},{\"x\":-13369,\"y\":190,\"z\":-220},{\"x\":-13365,\"y\":194,\"z\":-224},{\"x\":-13361,\"y\":191,\"z\":-222},{\"x\":-13375,\"y\":192,\"z\":-219},{\"x\":-13372,\"y\":195,\"z\":-228},{\"x\":-13378,\"y\":200,\"z\":-222},{\"x\":-13370,\"y\":191,\"z\":-226},{\"x\":-13389,\"y\":192,\"z\":-220},{\"x\":-13378,\"y\":194,\"z\":-214},{\"x\":-13382,\"y\":199,\"z\":-213},{\"x\":-13377,\"y\":196,\"z\":-219},{\"x\":-13367,\"y\":192,\"z\":-216},{\"x\":-13378,\"y\":187,\"z\":-213},{\"x\":-13376,\"y\":199,\"z\":-212},{\"x\":-13376,\"y\":199,\"z\":-212},{\"x\":-13375,\"y\":194,\"z\":-220},{\"x\":-13385,\"y\":196,\"z\":-223},{\"x\":-13390,\"y\":194,\"z\":-218},{\"x\":-13385,\"y\":182,\"z\":-227},{\"x\":-13374,\"y\":199,\"z\":-221},{\"x\":-13379,\"y\":193,\"z\":-213},{\"x\":-13372,\"y\":192,\"z\":-205},{\"x\":-13372,\"y\":205,\"z\":-212},{\"x\":-13374,\"y\":190,\"z\":-219},{\"x\":-13364,\"y\":193,\"z\":-223},{\"x\":-13369,\"y\":186,\"z\":-221},{\"x\":-13371,\"y\":182,\"z\":-220},{\"x\":-13394,\"y\":190,\"z\":-224},{\"x\":-13378,\"y\":191,\"z\":-219},{\"x\":-13382,\"y\":196,\"z\":-224},{\"x\":-13392,\"y\":183,\"z\":-217},{\"x\":-13388,\"y\":197,\"z\":-225},{\"x\":-13376,\"y\":189,\"z\":-218},{\"x\":-13391,\"y\":189,\"z\":-234},{\"x\":-13378,\"y\":176,\"z\":-233},{\"x\":-13381,\"y\":189,\"z\":-226},{\"x\":-13378,\"y\":191,\"z\":-225},{\"x\":-13393,\"y\":189,\"z\":-214},{\"x\":-13376,\"y\":196,\"z\":-218},{\"x\":-13384,\"y\":196,\"z\":-206},{\"x\":-13384,\"y\":201,\"z\":-230},{\"x\":-13377,\"y\":184,\"z\":-213},{\"x\":-13383,\"y\":181,\"z\":-224},{\"x\":-13374,\"y\":187,\"z\":-221},{\"x\":-13366,\"y\":188,\"z\":-219},{\"x\":-13363,\"y\":195,\"z\":-207},{\"x\":-13366,\"y\":185,\"z\":-212},{\"x\":-13369,\"y\":185,\"z\":-212},{\"x\":-13376,\"y\":189,\"z\":-231},{\"x\":-13371,\"y\":194,\"z\":-226},{\"x\":-13379,\"y\":192,\"z\":-223},{\"x\":-13362,\"y\":198,\"z\":-221},{\"x\":-13376,\"y\":186,\"z\":-211},{\"x\":-13373,\"y\":190,\"z\":-221},{\"x\":-13375,\"y\":184,\"z\":-233},{\"x\":-13374,\"y\":195,\"z\":-221},{\"x\":-13371,\"y\":188,\"z\":-222},{\"x\":-13386,\"y\":181,\"z\":-214},{\"x\":-13382,\"y\":189,\"z\":-213},{\"x\":-13380,\"y\":187,\"z\":-224},{\"x\":-13387,\"y\":191,\"z\":-213},{\"x\":-13386,\"y\":206,\"z\":-205},{\"x\":-13382,\"y\":202,\"z\":-220},{\"x\":-13372,\"y\":182,\"z\":-220},{\"x\":-13380,\"y\":191,\"z\":-205},{\"x\":-13366,\"y\":187,\"z\":-222},{\"x\":-13373,\"y\":200,\"z\":-208},{\"x\":-13372,\"y\":197,\"z\":-208},{\"x\":-13368,\"y\":202,\"z\":-210},{\"x\":-13369,\"y\":189,\"z\":-230},{\"x\":-13366,\"y\":178,\"z\":-213},{\"x\":-13380,\"y\":179,\"z\":-209},{\"x\":-13375,\"y\":194,\"z\":-227},{\"x\":-13373,\"y\":184,\"z\":-225},{\"x\":-13372,\"y\":189,\"z\":-219},{\"x\":-13376,\"y\":195,\"z\":-228},{\"x\":-13366,\"y\":204,\"z\":-215},{\"x\":-13373,\"y\":193,\"z\":-217},{\"x\":-13374,\"y\":188,\"z\":-238},{\"x\":-13385,\"y\":183,\"z\":-215},{\"x\":-13378,\"y\":189,\"z\":-222},{\"x\":-13375,\"y\":196,\"z\":-218},{\"x\":-13380,\"y\":198,\"z\":-219},{\"x\":-13385,\"y\":195,\"z\":-226},{\"x\":-13379,\"y\":198,\"z\":-221},{\"x\":-13384,\"y\":194,\"z\":-218},{\"x\":-13387,\"y\":195,\"z\":-208},{\"x\":-13382,\"y\":194,\"z\":-213},{\"x\":-13367,\"y\":196,\"z\":-223},{\"x\":-13356,\"y\":203,\"z\":-220},{\"x\":-13373,\"y\":199,\"z\":-225},{\"x\":-13363,\"y\":188,\"z\":-219},{\"x\":-13373,\"y\":194,\"z\":-227},{\"x\":-13376,\"y\":194,\"z\":-229},{\"x\":-13377,\"y\":193,\"z\":-216},{\"x\":-13376,\"y\":199,\"z\":-221},{\"x\":-13373,\"y\":192,\"z\":-224},{\"x\":-13374,\"y\":191,\"z\":-209},{\"x\":-13370,\"y\":192,\"z\":-218},{\"x\":-13377,\"y\":197,\"z\":-224},{\"x\":-13380,\"y\":194,\"z\":-223},{\"x\":-13387,\"y\":194,\"z\":-228},{\"x\":-13384,\"y\":195,\"z\":-224},{\"x\":-13385,\"y\":203,\"z\":-215},{\"x\":-13378,\"y\":198,\"z\":-222},{\"x\":-13380,\"y\":189,\"z\":-224},{\"x\":-13376,\"y\":190,\"z\":-223},{\"x\":-13384,\"y\":190,\"z\":-208},{\"x\":-13377,\"y\":190,\"z\":-213},{\"x\":-13374,\"y\":210,\"z\":-223},{\"x\":-13366,\"y\":181,\"z\":-215},{\"x\":-13369,\"y\":190,\"z\":-220},{\"x\":-13365,\"y\":194,\"z\":-224},{\"x\":-13361,\"y\":191,\"z\":-222},{\"x\":-13375,\"y\":192,\"z\":-219},{\"x\":-13372,\"y\":195,\"z\":-228},{\"x\":-13378,\"y\":200,\"z\":-222},{\"x\":-13370,\"y\":191,\"z\":-226},{\"x\":-13389,\"y\":192,\"z\":-220},{\"x\":-13378,\"y\":194,\"z\":-214},{\"x\":-13382,\"y\":199,\"z\":-213},{\"x\":-13377,\"y\":196,\"z\":-219},{\"x\":-13367,\"y\":192,\"z\":-216},{\"x\":-13378,\"y\":187,\"z\":-213},{\"x\":-13376,\"y\":199,\"z\":-212},{\"x\":-13376,\"y\":199,\"z\":-212}],\"time\":1664810617768}";

  
  int tx_channel=-1; int rx_channel=-1;
  size_t tx_size = 663 * sizeof(int);
  size_t rx_size = 3 * sizeof(int);
  const array_t *tx_chans, *rx_chans;
  char *tx_buf, *rx_buf;

  // Map memory regions for the transmit and receive buffers
  tx_buf = axidma_malloc(axidma_dev, tx_size);
  if (tx_buf == NULL) {
    perror("Unable to allocate transmit buffer from the AXI DMA device.");
    rc = -1;
    goto destroy_axidma;
  }
  rx_buf = axidma_malloc(axidma_dev, rx_size);
  if (rx_buf == NULL) {
    perror("Unable to allocate receive buffer from the AXI DMA device");
    rc = -1;
    goto free_tx_buf;
  }

  tx_chans = axidma_get_dma_tx(axidma_dev);
  rx_chans = axidma_get_dma_rx(axidma_dev);
  if (tx_chans->len < 1) {
    fprintf(stderr, "Error: No transmit channels were found.\n");
    rc = -1;
    goto free_rx_buf;
  }
  if (rx_chans->len < 1) {
    fprintf(stderr, "Error: No receive channels were found.\n");
    rc = -1;
    goto free_rx_buf;
  }
  
  /* If the user didn't specify the channels, we assume that the transmit and
   * receive channels are the lowest numbered ones. */
  if (tx_channel == -1 && rx_channel == -1) {
    tx_channel = tx_chans->data[0];
    rx_channel = rx_chans->data[0];
  }
  printf("Using transmit channel %d and receive channel %d.\n", tx_channel,
	 rx_channel);

  // Fill transmit buffer
  fill_tx_buffer(tx_buf, tx_size, message);

  // Calculated expected output
  printf("SOFTWARE: ");
  calc_output((int *)tx_buf, tx_size);
  
  for (int i=0; i<4; i++) {
    rc = axidma_oneway_transfer(axidma_dev, tx_channel, tx_buf, tx_size, true);
    rc = axidma_oneway_transfer(axidma_dev, rx_channel, rx_buf, rx_size, true);

    if (rc < 0) {
      return rc;
    }
    
    printf("HARDWARE: After %d. transfer => \t", i);
    print_buffer((int *) rx_buf, rx_size);
  }  
  
  printf("INFO: Stopping!\n");

  // freeup
 free_rx_buf:
  axidma_free(axidma_dev, rx_buf, rx_size);
 free_tx_buf:
  axidma_free(axidma_dev, tx_buf, tx_size);
 destroy_axidma:
  axidma_destroy(axidma_dev);
 ret:
  return rc;
  
}
